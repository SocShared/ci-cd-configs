stages:
  - docker-swarm-deploy-redis-postgres
  - docker-swarm-deploy-zipkin
  - docker-swarm-deploy-sentry
  - docker-swarm-deploy-rabbitmq

docker-swarm-deploy-redis-postgres:
  stage: docker-swarm-deploy-redis-postgres
  script:
    - sudo docker stack deploy -c deploy-redis-postgres.yaml socshared

docker-swarm-deploy-zipkin:
  stage: docker-swarm-deploy-zipkin
  script:
    - sudo docker stack deploy -c deploy-zipkin.yaml socshared

docker-swarm-deploy-sentry:
  stage: docker-swarm-deploy-sentry
  script:
    - touch .env
    - echo "SENTRY_SECRET_KEY=$SENTRY_KEY" >> .env
    - echo "SENTRY_POSTGRES_HOST=socshared_sentry_postgres" >> .env
    - echo "SENTRY_DB_USER=sentry" >> .env
    - echo "SENTRY_DB_PASSWORD=171322f63734464e9e58deb6e9a419e5" >> .env
    - echo "SENTRY_REDIS_HOST=socshared_sentry_redis" >> .env
    - sudo docker stack deploy -c deploy-sentry.yaml socshared
    - SERVICE_NAME=socshared_sentry
    - TASK_ID=$(sudo docker service ps --filter 'desired-state=running' $SERVICE_NAME -q)
    - NODE_ID=$(sudo docker inspect --format '{{ .NodeID }}' $TASK_ID)
    - CONTAINER_ID=$(sudo docker inspect --format '{{ .Status.ContainerStatus.ContainerID }}' $TASK_ID)
    - NODE_HOST=$(sudo docker node inspect --format '{{ .Description.Hostname }}' $NODE_ID)
    - export DOCKER_HOST="tcp://$NODE_HOST:2376"
    - sudo docker exec -it $CONTAINER_ID "sentry upgrade"
    - sudo docker exec -it $CONTAINER_ID "sentry createuser --email vladovchinnikov950@gmail.com --password admin --superuser --no-input"

docker-swarm-deploy-rabbitmq:
  stage: docker-swarm-deploy-rabbitmq
  script:
    - sudo docker stack deploy -c deploy-rabbitmq.yaml socshared